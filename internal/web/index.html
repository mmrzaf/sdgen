<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sdgen - Synthetic Data Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 30px; color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        select, input, textarea, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #4CAF50; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; font-weight: 500; margin-top: 10px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .runs-list { margin-top: 40px; }
        .runs-list h2 { margin-bottom: 20px; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: 600; color: #555; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-running { background: #2196F3; color: white; }
        .status-success { background: #4CAF50; color: white; }
        .status-failed { background: #f44336; color: white; }
        .status-pending { background: #FF9800; color: white; }
        a { color: #2196F3; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .error { color: #f44336; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>sdgen - Synthetic Data Generator</h1>
        
        <form id="runForm">
            <div class="form-group">
                <label for="scenario">Scenario</label>
                <select id="scenario" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="target">Target</label>
                <select id="target" required>
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="seed">Seed (optional)</label>
                <input type="number" id="seed" placeholder="Leave empty for random seed">
            </div>
            
            <div class="form-group">
                <label for="mode">Table Mode</label>
                <select id="mode">
                    <option value="create_if_missing">Create if Missing</option>
                    <option value="truncate_then_insert">Truncate then Insert</option>
                    <option value="append_only">Append Only</option>
                </select>
            </div>
            
            <button type="submit" id="startBtn">Start Run</button>
            <div id="error" class="error" style="display:none;"></div>
        </form>
        
        <div class="runs-list">
            <h2>Recent Runs</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Scenario</th>
                        <th>Target</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="runsTable">
                    <tr><td colspan="6">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let scenarios = [];
        let targets = [];

        async function loadScenarios() {
            try {
                const res = await fetch('/api/v1/scenarios');
                scenarios = await res.json();
                const select = document.getElementById('scenario');
                select.innerHTML = '<option value="">Select scenario...</option>' +
                    scenarios.map(s => `<option value="${s.id}">${s.name} (${s.version || 'v0'})</option>`).join('');
            } catch (e) {
                console.error('Failed to load scenarios:', e);
            }
        }

        async function loadTargets() {
            try {
                const res = await fetch('/api/v1/targets');
                targets = await res.json();
                const select = document.getElementById('target');
                select.innerHTML = '<option value="">Select target...</option>' +
                    targets.map(t => `<option value="${t.id}">${t.name} (${t.kind})</option>`).join('');
            } catch (e) {
                console.error('Failed to load targets:', e);
            }
        }

        async function loadRuns() {
            try {
                const res = await fetch('/api/v1/runs?limit=20');
                const runs = await res.json();
                const tbody = document.getElementById('runsTable');
                
                if (runs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No runs yet</td></tr>';
                    return;
                }

                tbody.innerHTML = runs.map(run => {
                    const date = new Date(run.started_at).toLocaleString();
                    return `
                        <tr>
                            <td>${run.id.substring(0, 8)}</td>
                            <td>${run.scenario_name}</td>
                            <td>${run.target_name}</td>
                            <td><span class="status status-${run.status}">${run.status}</span></td>
                            <td>${date}</td>
                            <td><a href="/runs/${run.id}">View</a></td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Failed to load runs:', e);
            }
        }

        document.getElementById('runForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const scenarioId = document.getElementById('scenario').value;
            const targetId = document.getElementById('target').value;
            const seedInput = document.getElementById('seed').value;
            const mode = document.getElementById('mode').value;
            
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'none';
            
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            try {
                const body = {
                    scenario_id: scenarioId,
                    target_id: targetId,
                    mode: mode
                };
                
                if (seedInput) {
                    body.seed = parseInt(seedInput);
                }
                
                const res = await fetch('/api/v1/runs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text);
                }
                
                const run = await res.json();
                setTimeout(loadRuns, 500);
                document.getElementById('runForm').reset();
            } catch (e) {
                errorDiv.textContent = 'Error: ' + e.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Start Run';
            }
        });

        loadScenarios();
        loadTargets();
        loadRuns();
        setInterval(loadRuns, 3000);
    </script>
</body>
</html>
