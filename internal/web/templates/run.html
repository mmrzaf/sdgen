<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Run</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 980px; margin: 0 auto; padding: 24px; }
    pre { background: #f6f6f6; padding: 12px; overflow: auto; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Run <span id="run-id"></span></h1>
  <p><a href="/">Home</a> Â· <a href="/targets">Targets</a></p>
  <div id="meta"></div>
  <h2>Progress</h2>
  <div id="progress" class="muted"></div>
  <h2>Run Logs</h2>
  <pre id="logs" class="muted"></pre>
  <h2>Raw</h2>
  <pre id="raw"></pre>
</div>

<script>
const runID = window.location.pathname.split('/').pop();
let pollID = null;

async function load() {
  const res = await fetch('/api/v1/runs/' + runID);
  if (!res.ok) {
    document.getElementById('raw').textContent = await res.text();
    return;
  }
  const run = await res.json();
  document.getElementById('run-id').textContent = run.id;

  const meta = document.getElementById('meta');
  meta.innerHTML = `
    <div><b>Scenario</b>: ${run.scenario_name} (${run.scenario_version})</div>
    <div><b>Target</b>: ${run.target_name} (${run.target_kind})</div>
    <div><b>Mode</b>: ${run.mode || ''}</div>
    <div><b>Scale</b>: ${run.scale || ''}</div>
  `;

  if (run.execution_order) {
    const eo = (typeof run.execution_order === 'string') ? JSON.parse(run.execution_order) : run.execution_order;
    meta.innerHTML += `<div><b>Execution order</b>: ${Array.isArray(eo) ? eo.join(', ') : ''}</div>`;
  }
  if (run.resolved_counts) {
    const rc = (typeof run.resolved_counts === 'string') ? JSON.parse(run.resolved_counts) : run.resolved_counts;
    meta.innerHTML += `<div><b>Resolved counts</b>: <code>${JSON.stringify(rc)}</code></div>`;
  }
  if (run.warnings) {
    const w = (typeof run.warnings === 'string') ? JSON.parse(run.warnings) : run.warnings;
    if (w && w.length) meta.innerHTML += `<div><b>Warnings</b>: <code>${JSON.stringify(w)}</code></div>`;
  }

  const rowsTotal = run.progress_rows_total || 0;
  const rowsDone = run.progress_rows_generated || 0;
  const entitiesTotal = run.progress_entities_total || 0;
  const entitiesDone = run.progress_entities_done || 0;
  const currentEntity = run.progress_current_entity || '-';
  const rowPct = rowsTotal > 0 ? ((rowsDone / rowsTotal) * 100).toFixed(1) : '0.0';
  document.getElementById('progress').innerHTML = `
    <div><b>Rows</b>: ${rowsDone} / ${rowsTotal} (${rowPct}%)</div>
    <div><b>Entities</b>: ${entitiesDone} / ${entitiesTotal}</div>
    <div><b>Current Entity</b>: ${currentEntity}</div>
  `;

  document.getElementById('raw').textContent = JSON.stringify(run, null, 2);
  const lr = await fetch('/api/v1/runs/' + runID + '/logs?limit=300');
  if (lr.ok) {
    const logs = await lr.json();
    const text = logs
      .slice()
      .reverse()
      .map(l => `[${l.created_at}] ${l.level.toUpperCase()} ${l.message}`)
      .join('\n');
    document.getElementById('logs').textContent = text || '(no logs yet)';
  }
  if (run.status === 'success' || run.status === 'failed') {
    if (pollID) {
      clearInterval(pollID);
      pollID = null;
    }
  }
}

pollID = setInterval(load, 1000);
load();
</script>
</body>
</html>
