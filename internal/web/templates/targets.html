<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Targets</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 980px; margin: 0 auto; padding: 24px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color: #666; font-size: 12px; }
    button { padding: 8px 12px; }
    pre { background: #f6f6f6; padding: 12px; overflow: auto; }
  </style>
</head>
<body>
<div class="container">
  <h1>Targets</h1>
  <p><a href="/">Home</a></p>

  <h2>Add / Update</h2>
  <div class="row">
    <div>
      <label>ID (blank for new)</label>
      <input id="t-id" placeholder="(auto)" />
    </div>
    <div>
      <label>Name</label>
      <input id="t-name" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Kind</label>
      <select id="t-kind">
        <option value="postgres">postgres</option>
        <option value="sqlite">sqlite</option>
        <option value="elasticsearch">elasticsearch</option>
      </select>
    </div>
    <div>
      <label>Schema (postgres)</label>
      <input id="t-schema" placeholder="public" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Default Database (postgres)</label>
      <input id="t-database" placeholder="appdb" />
    </div>
    <div>
      <label>Host</label>
      <input id="dsn-host" placeholder="localhost" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Port</label>
      <input id="dsn-port" type="number" placeholder="5432 / 27017 / 9200" />
    </div>
    <div>
      <label>User</label>
      <input id="dsn-user" placeholder="dbuser" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Password</label>
      <input id="dsn-password" type="password" placeholder="secret" />
    </div>
    <div>
      <label>SSL Mode / Scheme</label>
      <input id="dsn-extra" placeholder="disable / https" />
    </div>
  </div>
  <label>DSN (stored raw; shown redacted)</label>
  <input id="t-dsn" />
  <div style="display:flex;gap:8px;margin-top:12px;">
    <button id="build-dsn-btn" type="button">Build DSN</button>
    <button id="save-btn">Save</button>
    <button id="clear-btn" type="button">Clear</button>
  </div>
  <p class="muted">Click a row to load into the form. DSN is not reloaded from the API.</p>

  <h2>List</h2>
  <table>
    <thead>
      <tr><th>Name</th><th>Kind</th><th>Schema</th><th>DSN</th><th>Actions</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <h2>Test output</h2>
  <pre id="test-out" class="muted"></pre>
</div>

<script>
function setForm(t) {
  document.getElementById('t-id').value = t?.id || '';
  document.getElementById('t-name').value = t?.name || '';
  document.getElementById('t-kind').value = t?.kind || 'postgres';
  document.getElementById('t-database').value = t?.database || '';
  document.getElementById('t-schema').value = t?.schema || '';
  document.getElementById('t-dsn').value = '';
}

async function loadTargets() {
  const res = await fetch('/api/v1/targets');
  const targets = await res.json();
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';

  for (const t of targets) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.name}</td>
      <td>${t.kind}</td>
      <td>${t.schema || ''}</td>
      <td class="muted">${t.dsn || ''}</td>
      <td>
        <button data-act="test">Test</button>
        <button data-act="del">Delete</button>
      </td>
    `;

    tr.addEventListener('click', (e) => {
      if (e.target?.dataset?.act) return;
      setForm(t);
    });

    tr.querySelector('[data-act="test"]').addEventListener('click', async (e) => {
      e.stopPropagation();
      const out = document.getElementById('test-out');
      out.textContent = 'Testing...';
      const r = await fetch(`/api/v1/targets/${t.id}/test`, { method: 'POST' });
      out.textContent = r.ok ? JSON.stringify(await r.json(), null, 2) : await r.text();
    });

    tr.querySelector('[data-act="del"]').addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm('Delete target?')) return;
      const r = await fetch(`/api/v1/targets/${t.id}`, { method: 'DELETE' });
      if (!r.ok) alert(await r.text());
      await loadTargets();
    });

    tbody.appendChild(tr);
  }
}

document.getElementById('save-btn').addEventListener('click', async () => {
  const id = document.getElementById('t-id').value.trim();
  const name = document.getElementById('t-name').value.trim();
  const kind = document.getElementById('t-kind').value;
  const schema = document.getElementById('t-schema').value.trim();
  const database = document.getElementById('t-database').value.trim();
  const dsn = document.getElementById('t-dsn').value.trim();

  const payload = { id, name, kind, schema, database, dsn };

  let res;
  if (!id) {
    res = await fetch('/api/v1/targets', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  } else {
    res = await fetch(`/api/v1/targets/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  }

  if (!res.ok) {
    alert(await res.text());
    return;
  }

  setForm(null);
  await loadTargets();
});

document.getElementById('clear-btn').addEventListener('click', () => setForm(null));
document.getElementById('build-dsn-btn').addEventListener('click', () => {
  const kind = document.getElementById('t-kind').value;
  const host = document.getElementById('dsn-host').value.trim() || 'localhost';
  const portRaw = document.getElementById('dsn-port').value.trim();
  const user = document.getElementById('dsn-user').value.trim();
  const password = document.getElementById('dsn-password').value.trim();
  const database = document.getElementById('t-database').value.trim();
  const extra = document.getElementById('dsn-extra').value.trim();
  let dsn = '';

  if (kind === 'postgres') {
    const port = portRaw || '5432';
    const db = database || 'appdb';
    const sslmode = extra || 'disable';
    const auth = user ? `${encodeURIComponent(user)}:${encodeURIComponent(password)}@` : '';
    dsn = `postgres://${auth}${host}:${port}/${encodeURIComponent(db)}?sslmode=${encodeURIComponent(sslmode)}`;
  } else if (kind === 'elasticsearch') {
    const port = portRaw || '9200';
    const scheme = extra || 'http';
    const auth = user ? `${encodeURIComponent(user)}:${encodeURIComponent(password)}@` : '';
    dsn = `${scheme}://${auth}${host}:${port}`;
  } else if (kind === 'sqlite') {
    dsn = database || './target.sqlite';
  }
  document.getElementById('t-dsn').value = dsn;
});
loadTargets();
</script>
</body>
</html>
